#!/bin/bash
set -x
set -e
set -o pipefail

ssh -F .sshconfig dev '/bin/bash -s' << "EOF"
set -x
set -e
set -o pipefail

cd '/root/docker'
git status
git diff
git stash || true
git pull --rebase
git stash pop || true

export PDS_CARTAS_REPOSITORIO='https://github.com/servicosgovbr/cartas-de-teste.git'
export EDS_CARTAS_REPOSITORIO='git@github.com:servicosgovbr/cartas-de-teste.git'

./build portal-de-servicos

docker-compose stop portal1 portal2
docker-compose kill portal1 portal2
docker-compose rm -f portal1 portal2

docker-compose up -d
docker-compose restart balanceador

EOF
